name: Extract Facebook Metadata and Upload Artifact

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  extract-metadata:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Install dependencies (curl, jq, etc.)
      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # Extract metadata from Facebook URL
      - name: Extract metadata from Facebook URL
        run: |
          # Define the Facebook URL
          FB_URL="https://www.facebook.com/story.php?story_fbid=122107539026822761&id=61574682854737"
          
          # Fetch page HTML
          HTML=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "$FB_URL")
          
          # Extract metadata using grep and jq
          TITLE=$(echo "$HTML" | grep -oP '(?<=<meta property="og:title" content=")[^"]+')
          DESCRIPTION=$(echo "$HTML" | grep -oP '(?<=<meta property="og:description" content=")[^"]+')
          IMAGE=$(echo "$HTML" | grep -oP '(?<=<meta property="og:image" content=")[^"]+')
          POST_TYPE="story"
          STATUS="success"

          # Format as JSON
          JSON=$(jq -n \
            --arg url "$FB_URL" \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --arg image "$IMAGE" \
            --arg status "$STATUS" \
            --arg post_type "$POST_TYPE" \
            '{url: $url, title: $title, description: $description, image: $image, status: $status, post_type: $post_type}')
          
          echo "$JSON" > metadata.json

      # Upload the metadata JSON as artifact
      - name: Upload metadata artifact
        uses: actions/upload-artifact@v2
        with:
          name: metadata
          path: metadata.json

  # Optionally, you can add another job to deploy the metadata or use it elsewhere
