name: Extract Facebook Metadata

on:
  workflow_dispatch:
  push:
    paths:
      - 'urls.txt'

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cài các công cụ cần thiết
        run: sudo apt-get update && sudo apt-get install -y curl jq sed grep gawk

      - name: Tạo script trích xuất
        run: |
          cat <<'EOF' > extract.sh
          #!/bin/bash
          set -e

          PLACEHOLDER_IMG="https://cuacuondaiphucvinh.com/wp-content/uploads/2024/12/icon-loi.jpg"
          OUTPUT_JSON="output.json"
          > "$OUTPUT_JSON"

          decode_html_entities() {
            input="$1"
            decoded=$(echo "$input" | sed -e 's/&quot;/"/g' -e "s/&#39;/'/g" -e 's/&lt;/</g' -e 's/&gt;/>/g' -e 's/&amp;/\&/g')
            echo "$decoded" | awk '{
              while (match($0, /&#[0-9]+;/)) {
                num = substr($0, RSTART+2, RLENGTH-3);
                chr = sprintf("%c", num);
                $0 = substr($0, 1, RSTART-1) chr substr($0, RSTART+RLENGTH);
              }
              print;
            }'
          }

          get_post_type_from_url() {
            case "$1" in
              *"/reel/"*) echo "reel";;
              *"/story.php"*|*"/stories/"*) echo "story";;
              *"/video"*|*"/watch"*|*"/videos/"*) echo "video";;
              *"/photo"*|*"/photos/"*) echo "photo";;
              *"/groups/"*) echo "group_post";;
              *"/posts/"*) echo "post";;
              *"/events/"*) echo "event";;
              *"facebook.com/"*) echo "profile";;
              *) echo "unknown";;
            esac
          }

          while read -r url; do
            [ -z "$url" ] && continue
            html=$(curl -sL --max-time 15 -A "Mozilla/5.0" "$url")
            if [ $? -ne 0 ] || [ -z "$html" ]; then
              title="Bài viết lỗi"
              desc="Không có nội dung"
              img="$PLACEHOLDER_IMG"
              status="error"
            else
              title=$(echo "$html" | grep -oP '(?<=<title>).*?(?=</title>)' | head -n1)
              og_title=$(echo "$html" | grep -oP '<meta property="og:title" content="\\K[^"]*' | head -n1)
              og_desc=$(echo "$html" | grep -oP '<meta property="og:description" content="\\K[^"]*' | head -n1)
              og_img=$(echo "$html" | grep -oP '<meta property="og:image" content="\\K[^"]*' | head -n1)

              final_title=${og_title:-${title:-"Bài viết lỗi"}}
              final_desc=$(decode_html_entities "${og_desc:-"Không có nội dung"}")
              final_image=${og_img:-$PLACEHOLDER_IMG}

              if [ -n "$og_desc" ] || [ "$final_image" != "$PLACEHOLDER_IMG" ]; then
                status="success"
              else
                if echo "$html" | grep -qi "login"; then status="login"
                elif echo "$html" | grep -qi "content not found\\|unavailable\\|removed"; then status="link_hỏng"
                else status="error"
                fi
              fi
            fi

            post_type=$(get_post_type_from_url "$url")
            safe_title=$(echo "$final_title" | sed 's/"/\\"/g')
            safe_desc=$(echo "$final_desc" | sed 's/"/\\"/g')
            safe_img=$(echo "$final_image" | sed 's/"/\\"/g')

            printf '{"url":"%s","title":"%s","description":"%s","image":"%s","status":"%s","post_type":"%s"}\n' \
              "$url" "$safe_title" "$safe_desc" "$safe_img" "$status" "$post_type" >> "$OUTPUT_JSON"
          done < urls.txt
          EOF
          chmod +x extract.sh

      - name: Chạy script trích xuất
        run: ./extract.sh

      - name: Upload file output.json
        uses: actions/upload-artifact@v3
        with:
          name: fb-meta
          path: output.json
