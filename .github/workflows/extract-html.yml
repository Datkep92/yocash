name: Extract HTML from URLs

on:
  workflow_dispatch:
    inputs:
      gist_id:
        description: 'ID của Gist chứa file .txt với danh sách URL'
        required: true

jobs:
  extract:
    runs-on: ubuntu-latest

    steps:
      - name: Cài đặt jq và curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Lấy nội dung file raw từ Gist
        run: |
          # Lấy raw_url của file urls.txt trong Gist
          RAW_URL=$(curl -s -H "Authorization: token ${{ secrets.dat_kep }}" \
            https://api.github.com/gists/${{ github.event.inputs.gist_id }} \
            | jq -r '.files["urls.txt"].raw_url')

          # Kiểm tra nếu không tìm thấy file urls.txt
          if [ -z "$RAW_URL" ] || [ "$RAW_URL" = "null" ]; then
            printf "❌ Error: File urls.txt not found in Gist.\n"
            exit 1
          fi

          # Tải danh sách URL dạng raw text
          curl -L "$RAW_URL" -o urls.txt
          echo "✅ Đã tải urls.txt thành công"

      - name: Trích xuất HTML và metadata
        run: |
          placeholder_img="https://cuacuondaiphucvinh.com/wp-content/uploads/2024/12/icon-loi.jpg"

          decode_html_entities() {
            input="$1"
            decoded=$(echo "$input" | sed -e 's/&quot;/"/g' \
                                      -e "s/&#39;/'/g" \
                                      -e 's/&lt;/</g' \
                                      -e 's/&gt;/>/g' \
                                      -e 's/&amp;/\&/g')
            echo "$decoded" | awk '{
              while (match($0, /&#[0-9]+;/)) {
                num = substr($0, RSTART+2, RLENGTH-3);
                chr = sprintf("%c", num);
                $0 = substr($0, 1, RSTART-1) chr substr($0, RSTART+RLENGTH);
              }
              print;
            }'
          }

          escape_json() {
            echo "$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'
          }

          get_post_type_from_url() {
            url="$1"
            if echo "$url" | grep -qE "/reel/"; then echo "reel"
            elif echo "$url" | grep -qE "/story.php|/stories/"; then echo "story"
            elif echo "$url" | grep -qE "/video|/watch|/videos/"; then echo "video"
            elif echo "$url" | grep -qE "/photo|/photos/"; then echo "photo"
            elif echo "$url" | grep -qE "/groups/"; then echo "group_post"
            elif echo "$url" | grep -qE "/posts/"; then echo "post"
            elif echo "$url" | grep -qE "/events/"; then echo "event"
            elif echo "$url" | grep -qE "facebook.com/[^/]+/$"; then echo "profile"
            else echo "unknown"
            fi
          }

          INPUT_TXT="urls.txt"
          OUTPUT_JSON="processed_urls.jsonl"
          > "$OUTPUT_JSON"

          while read -r line; do
            [ -z "$line" ] && continue
            raw_link=$(echo "$line" | grep -oE 'https?://(www\.|m\.|fb\.|l\.|business\.)?facebook\.com[^[:space:]]+' | tail -n1)
            [ -z "$raw_link" ] && echo "{\"error\":\"Không tìm thấy URL hợp lệ trong dòng: $line\"}" && continue

            info=$(curl -Ls -o /dev/null -w "%{url_effective} %{http_code}" "$raw_link")
            final_link=$(echo "$info" | awk '{print $1}')
            http_code=$(echo "$info" | awk '{print $2}')
            [ -z "$final_link" ] && echo "{\"error\":\"Không lấy được URL cuối cho $line\"}" && continue

            if echo "$final_link" | grep -q "login"; then
              decoded=$(echo "$final_link" | sed -E 's/.*next=([^\&]+).*/\1/' | sed 's/%/\\x/g' | xargs -0 echo -e)
              final_link="$decoded"
            fi

            cleaned=$(echo "$final_link" | sed -E 's/([&?])(mibextid|rdid|share_url)=[^&]*//g' |
                      sed -E 's/[&?]+$//' | sed -E 's/[?&]{2,}/\&/g' | sed -E 's/\?&/\?/' | sed -E 's/&\?/\?/')

            html=$(curl -sL --max-time 15 -A "Mozilla/5.0" "$cleaned")

            final_title="Bài viết lỗi"
            final_desc="Không có nội dung"
            final_image="$placeholder_img"
            post_status="error"

            if [ -n "$html" ]; then
              title=$(echo "$html" | grep -oP '(?<=<title>).*?(?=</title>)' | head -n1)
              og_title=$(echo "$html" | grep -oP '<meta property="og:title" content="\K[^"]*' | head -n1)
              og_desc=$(echo "$html" | grep -oP '<meta property="og:description" content="\K[^"]*' | head -n1)
              og_image=$(echo "$html" | grep -oP '<meta property="og:image" content="\K[^"]*' | head -n1)

              [ -n "$og_title" ] && final_title="$og_title"
              [ -z "$og_title" ] && [ -n "$title" ] && final_title="$title"

              [ -n "$og_desc" ] && final_desc=$(decode_html_entities "$og_desc")
              [ -n "$og_image" ] && final_image="$og_image"

              if [ -n "$og_desc" ] || [ "$final_image" != "$placeholder_img" ]; then
                post_status="success"
              else
                if echo "$html" | grep -qi "login"; then post_status="login"
                elif echo "$html" | grep -qi "content not found\|unavailable\|removed"; then post_status="link_hỏng"
                else post_status="error"
                fi
              fi
            fi

            post_type=$(get_post_type_from_url "$cleaned")
            safe_title=$(escape_json "$final_title")
            safe_desc=$(escape_json "$final_desc")
            safe_img=$(escape_json "$final_image")

            printf '{"url":"%s","title":"%s","description":"%s","image":"%s","status":"%s","post_type":"%s"}\n' \
              "$cleaned" "$safe_title" "$safe_desc" "$safe_img" "$post_status" "$post_type" >> "$OUTPUT_JSON"

          done < "$INPUT_TXT"

          echo "✅ Đã tạo $OUTPUT_JSON"

      - name: Cập nhật Gist với kết quả
        run: |
          set -e
          GIST_ID="${{ github.event.inputs.gist_id }}"
          CONTENT=$(jq -Rs . < processed_urls.jsonl)

          curl -X PATCH \
            -H "Authorization: token ${{ secrets.dat_kep }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"files\":{\"processed_urls.jsonl\":{\"content\":$CONTENT}}}" \
            https://api.github.com/gists/$GIST_ID

          echo "✅ Đã cập nhật processed_urls.jsonl trong Gist!"
